name: Update ZXingCpp SPM package

on:
  workflow_dispatch:
  schedule:
    - cron: '0 0 * * *' # Runs every day at midnight UTC

jobs:
  check-version-and-build:
    runs-on: macos-latest
    steps:
      - name: Get latest ZXingCpp version
        id: latest-version
        run: |
          echo "latest_version=${{ env.LATEST_VERSION }}" >> $GITHUB_ENV
          echo "Latest version: ${{ env.LATEST_VERSION }}"
        env:
          LATEST_VERSION: $(curl -s https://api.github.com/repos/zxing-cpp/zxing-cpp/releases/latest | jq -r '.tag_name')
      - name: Get current XCFramework version
        id: current-version
        run: |
          echo "current_version=${{ env.CURRENT_VERSION }}" >> $GITHUB_ENV
          echo "Current version: ${{ env.CURRENT_VERSION }}"
        env:
          CURRENT_VERSION: $(curl -s https://github.com/Kristijan22/zxing-cpp-ios-xcframework/releases/latest | jq -r '.tag_name')
      - name: Compare versions
        id: compare-versions
        run: |
          # Compare the latest remote release version to the current released version
          if [ "${{ env.latest_version }}" \> "${{ env.current_version }}" ]; then
            echo "Newer version found: ${{ env.latest_version }}"
            echo "update_needed=true" >> $GITHUB_ENV
          else
            echo "Already up-to-date."
            echo "update_needed=false" >> $GITHUB_ENV
          fi
      - name: Checkout
        if: ${{ env.update_needed == true }}
        uses: actions/checkout@v2
        with:
          submodules: 'recursive'
      - name: Build ZXingCpp
        if: ${{ env.update_needed == true }}
        run: ./build.sh
      - name: Compute checksum
        if: ${{ env.update_needed == true }}
        id: checksum
        run: |
          # Compute the SHA-256 checksum of the ZXingCpp.xcframework.zip
          swift package compute-checksum ZXingCpp.xcframework.zip | awk '{print $1}' > checksum
          echo "Checksum computed."
        shell: bash
        if: ${{ success() }}
      - name: Update Package.swift
        if: ${{ env.update_needed == true }}
        run: |
          # Replace the version and checksum in Package.swift with the latest remote release version and checksum
          sed -i '' "s/\(url: \"https:\/\/github\.com\/zxing-cpp\/zxing-cpp\/archive\/\)\(.*\)\(.zip\", checksum: \"\)\(.*\)\(\".*\)/\1$(cat latest_version.env)\3$(cat checksum)\5/" Package.swift
          echo "Package.swift updated."
#        if: ${{ success() }}
#      - name: Create new release and upload asset
#        env:
#          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
#        run: |
#          # Create a new GitHub release and save the release ID to a file
#          RELEASE_ID=$(curl --silent --data '{"tag_name": "$(cat latest_version.env)", "target_commitish": "$(git rev-parse HEAD)", "name": "$(cat latest_version.env)", "body": "Release $(cat latest_version.env)" }' --header "Authorization: Bearer ${GITHUB_TOKEN}" --header "Content-Type: application/json" https://api.github.com/repos/${{ github.repository }}/releases | jq -r '.id')
#          echo "Created release with ID $RELEASE_ID"
#
#          # Upload the asset to the new release
#          UPLOAD_URL="https://uploads.github.com/repos/${{ github.repository }}/releases/$RELEASE_ID/assets?name=ZXingCpp.xcframework.zip"
#          curl --silent --header "Authorization: Bearer ${GITHUB_TOKEN}" --header "Content-Type: application/zip" --upload-file ".build/release/ZXingCpp.xcframework.zip" "$UPLOAD_URL"
#
#          # Output the URL of the uploaded asset
#          ASSET_URL="https://github.com/${{ github.repository }}/releases/download/$(cat latest_version.env)/ZXingCpp.xcframework.zip"
#          echo "Uploaded asset to $ASSET_URL"
#        if: ${{ success() }}
      - name: Commit Package.swift
        if: ${{ env.update_needed == true }}
        run: |
          # Commit the updated Package.swift file
          git add Package.swift
          git commit -m "Bump version to ${{ env.latest_version }}"
          git push
